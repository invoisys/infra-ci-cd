# Composite Build Workflow
# Technology-agnostic build workflow supporting .NET and Node.js

name: Build

on:
  workflow_call:
    inputs:
      technology:
        description: 'Technology: dotnet or node'
        required: false
        type: string
        default: 'dotnet'
      technology_version:
        description: 'SDK version (e.g., 8.0 for .NET, 20 for Node)'
        required: false
        type: string
        default: ''
      working_directory:
        description: 'Source code directory'
        required: false
        type: string
        default: 'src'
      project_name:
        description: 'Project name (for .NET .csproj)'
        required: false
        type: string
        default: ''
      build_args:
        description: 'Additional build arguments'
        required: false
        type: string
        default: ''
    outputs:
      build_success:
        description: 'Whether build completed successfully'
        value: ${{ jobs.build.outputs.build_success }}

jobs:
  build:
    name: Build (${{ inputs.technology }})
    runs-on: ubuntu-latest
    outputs:
      build_success: ${{ steps.build.outputs.success }}

    steps:
      - name: Validate technology
        run: |
          TECH="${{ inputs.technology }}"
          case "$TECH" in
            dotnet|node) echo "âœ… Technology: $TECH" ;;
            *) echo "âŒ Unknown technology: $TECH. Supported: dotnet, node" && exit 1 ;;
          esac

      - name: Checkout
        uses: actions/checkout@v4

      # ===== .NET Setup =====
      - name: Setup .NET
        if: inputs.technology == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.technology_version || '8.0' }}

      - name: Cache NuGet
        if: inputs.technology == 'dotnet'
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles(format('{0}/**/*.csproj', inputs.working_directory)) }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ===== Node.js Setup =====
      - name: Setup Node.js
        if: inputs.technology == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.technology_version || '20' }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      # ===== Build =====
      - name: Build (.NET)
        id: build-dotnet
        if: inputs.technology == 'dotnet'
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "ðŸ“¦ Restoring dependencies..."
          dotnet restore
          echo "ðŸ”¨ Building..."
          dotnet build --no-restore --configuration Release ${{ inputs.build_args }}
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Build (Node.js)
        id: build-node
        if: inputs.technology == 'node'
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "ðŸ”¨ Building..."
          npm run build ${{ inputs.build_args }}
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Set build success
        id: build
        run: |
          if [ "${{ inputs.technology }}" = "dotnet" ]; then
            echo "success=${{ steps.build-dotnet.outputs.success || 'false' }}" >> $GITHUB_OUTPUT
          else
            echo "success=${{ steps.build-node.outputs.success || 'false' }}" >> $GITHUB_OUTPUT
          fi



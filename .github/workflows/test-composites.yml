# Test Composite Workflows
# Validates each composite workflow in isolation

name: Test Composites

on:
  workflow_dispatch:
    inputs:
      test_dotnet:
        description: 'Test .NET workflows'
        type: boolean
        default: true
      test_node:
        description: 'Test Node.js workflows'
        type: boolean
        default: true
      test_docker:
        description: 'Test Docker workflow (dry-run)'
        type: boolean
        default: true

jobs:
  # ===== Test Build (.NET) =====
  test-build-dotnet:
    name: "Build (.NET)"
    if: ${{ inputs.test_dotnet }}
    uses: ./.github/workflows/composite-build.yml
    with:
      technology: dotnet
      technology_version: '8.0'
      working_directory: exemplo-uso-pipeline/src

  # ===== Test Build (Node.js) =====
  test-build-node:
    name: "Build (Node.js)"
    if: ${{ inputs.test_node }}
    uses: ./.github/workflows/composite-build.yml
    with:
      technology: node
      technology_version: '20'
      working_directory: '.'

  # ===== Test Tests (.NET) =====
  test-tests-dotnet:
    name: "Test (.NET)"
    if: ${{ inputs.test_dotnet }}
    uses: ./.github/workflows/composite-test.yml
    with:
      technology: dotnet
      technology_version: '8.0'
      working_directory: exemplo-uso-pipeline/src
      skip_tests: false

  # ===== Test Tests (Skip) =====
  test-tests-skip:
    name: "Test (Skip)"
    uses: ./.github/workflows/composite-test.yml
    with:
      technology: dotnet
      skip_tests: true

  # ===== Test Docker (Dry-run) =====
  test-docker-dryrun:
    name: "Docker (Dry-run)"
    if: ${{ inputs.test_docker }}
    uses: ./.github/workflows/composite-docker.yml
    with:
      ecr_repo: test-repo
      service_type: api
      push: false
      use_template_dockerfile: false
      dockerfile_path: build/Dockerfile.api
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ===== Summary =====
  summary:
    name: "Summary"
    needs: 
      - test-build-dotnet
      - test-build-node
      - test-tests-dotnet
      - test-tests-skip
      - test-docker-dryrun
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# üß™ Composite Workflows Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Technology | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Build .NET
          if [ "${{ needs.test-build-dotnet.result }}" = "success" ]; then
            echo "| build.yml | .NET | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-build-dotnet.result }}" = "skipped" ]; then
            echo "| build.yml | .NET | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| build.yml | .NET | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build Node
          if [ "${{ needs.test-build-node.result }}" = "success" ]; then
            echo "| build.yml | Node | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-build-node.result }}" = "skipped" ]; then
            echo "| build.yml | Node | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| build.yml | Node | ‚ö†Ô∏è Expected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test .NET
          if [ "${{ needs.test-tests-dotnet.result }}" = "success" ]; then
            echo "| test.yml | .NET | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-tests-dotnet.result }}" = "skipped" ]; then
            echo "| test.yml | .NET | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| test.yml | .NET | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Skip
          if [ "${{ needs.test-tests-skip.result }}" = "success" ]; then
            echo "| test.yml | skip_tests | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| test.yml | skip_tests | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Docker
          if [ "${{ needs.test-docker-dryrun.result }}" = "success" ]; then
            echo "| docker.yml | dry-run | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-docker-dryrun.result }}" = "skipped" ]; then
            echo "| docker.yml | dry-run | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docker.yml | dry-run | ‚ö†Ô∏è Expected |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Run ID: ${{ github.run_id }} | Triggered by: ${{ github.triggering_actor }}*" >> $GITHUB_STEP_SUMMARY

      - name: Check Critical Tests
        run: |
          # Only fail if critical tests failed
          BUILD_DOTNET="${{ needs.test-build-dotnet.result }}"
          TEST_DOTNET="${{ needs.test-tests-dotnet.result }}"
          TEST_SKIP="${{ needs.test-tests-skip.result }}"
          
          if [ "$BUILD_DOTNET" = "failure" ] || [ "$TEST_DOTNET" = "failure" ] || [ "$TEST_SKIP" = "failure" ]; then
            echo "‚ùå Critical tests failed"
            exit 1
          fi
          
          echo "‚úÖ All critical tests passed"

# Rollback manual: reverter o service ECS para uma imagem especÃ­fica (tag ou SHA).
# CompatÃ­vel com o pipeline que gera nova task definition a cada deploy: o rollback
# registra uma nova revisÃ£o da task definition com a imagem desejada e atualiza o service.
# ReutilizÃ¡vel via workflow_dispatch (no repo da app) ou workflow_call.
# Para environment prd, use Required reviewers no GitHub Environment para aprovaÃ§Ã£o.

name: Rollback ECS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente alvo (dev, qa, sbx, prd)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - sbx
          - prd
      deployment_name:
        description: 'Nome do deployment (mesmo do deploy)'
        required: true
        type: string
      image_tag_or_sha:
        description: 'Tag ou SHA da imagem para rollback (ex.: abc1234 ou prd-20250130)'
        required: true
        type: string
      reason:
        description: 'Motivo do rollback (auditoria)'
        required: true
        type: string
      aws_region:
        description: 'RegiÃ£o AWS'
        required: false
        type: string
        default: 'us-east-1'
  workflow_call:
    inputs:
      environment:
        description: 'Ambiente alvo'
        required: true
        type: string
      deployment_name:
        description: 'Nome do deployment'
        required: true
        type: string
      image_tag_or_sha:
        description: 'Tag ou SHA da imagem'
        required: true
        type: string
      reason:
        description: 'Motivo do rollback'
        required: true
        type: string
      aws_region:
        description: 'RegiÃ£o AWS'
        required: false
        type: string
        default: 'us-east-1'
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      ECS_CLUSTER:
        required: true
      ECS_SERVICE:
        required: true

jobs:
  rollback:
    name: Rollback to image
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      service_arn: ${{ steps.rollback.outputs.service_arn }}
      image_used: ${{ steps.rollback.outputs.image_used }}
    steps:
      - name: Validar ambiente
        id: validate
        run: |
          ENV="${{ inputs.environment }}"
          case "$ENV" in
            dev|qa|sbx|prd) echo "âœ… Ambiente: $ENV" ;;
            *) echo "âŒ Ambiente invÃ¡lido: $ENV"; exit 1 ;;
          esac
          echo "Rollback solicitado para $ENV - imagem ${{ inputs.image_tag_or_sha }}"
          echo "Motivo: ${{ inputs.reason }}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Rollback ECS service
        id: rollback
        env:
          CLUSTER: ${{ secrets.ECS_CLUSTER }}
          SERVICE: ${{ secrets.ECS_SERVICE }}
          TAG: ${{ inputs.image_tag_or_sha }}
          DEPLOYMENT: ${{ inputs.deployment_name }}
        run: |
          set -e
          echo "ðŸ”„ Revertendo service $SERVICE no cluster $CLUSTER para imagem:$TAG"
          TASK_DEF_ARN=$(aws ecs describe-services --cluster "$CLUSTER" --services "$SERVICE" --query 'services[0].taskDefinition' --output text)
          TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition "$TASK_DEF_ARN" --query 'taskDefinition')
          CONTAINER_NAME=$(echo "$TASK_DEF_JSON" | jq -r '.containerDefinitions[0].name')
          IMAGE_URI=$(echo "$TASK_DEF_JSON" | jq -r '.containerDefinitions[0].image')
          REGISTRY_REPO=$(echo "$IMAGE_URI" | cut -d':' -f1)
          NEW_IMAGE="${REGISTRY_REPO}:${TAG}"
          echo "Nova imagem: $NEW_IMAGE"
          NEW_TASK_DEF=$(echo "$TASK_DEF_JSON" | jq --arg img "$NEW_IMAGE" 'del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy) | .containerDefinitions[0].image = $img')
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --task-definition "$NEW_TASK_DEF_ARN" --force-new-deployment --query 'service.serviceArn' --output text
          echo "service_arn=$(aws ecs describe-services --cluster $CLUSTER --services $SERVICE --query 'services[0].serviceArn' --output text)" >> $GITHUB_OUTPUT
          echo "image_used=${NEW_IMAGE}" >> $GITHUB_OUTPUT
          echo "â³ Aguardando deployment do rollback..."
          aws ecs wait services-stable --cluster "$CLUSTER" --services "$SERVICE"
          echo "âœ… Rollback concluÃ­do: $SERVICE usando $NEW_IMAGE"

      - name: Registrar rollback (auditoria)
        run: |
          echo "## Rollback executado" >> $GITHUB_STEP_SUMMARY
          echo "- **Ambiente:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagem:** ${{ steps.rollback.outputs.image_used }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Motivo:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY